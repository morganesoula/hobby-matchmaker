name: Run Unit Tests

on:
    push:
        branches: ["develop", "auth"]
    pull_request:
        branches: ["main", "develop"]
    workflow_dispatch:

jobs:
    run-tests:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Cache Gradle dependencies
              uses: actions/cache@v4
              with:
                path: |
                    ~/.gradle/caches
                    ~/.gradle/wrapper
                key: >
                    ${{ runner.os }}-gradle-
                    ${{ hashFiles('**/*.gradle', '**/gradle-wrapper.properties') }}
                restore-keys: ${{ runner.os }}-gradle-

            - name: Set up JDK 17
              uses: actions/setup-java@v3
              with:
                  java-version: '17'
                  distribution: 'zulu'
                  cache: gradle

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Get Facebook client token
              env:
                FACEBOOK_CLIENT_TOKEN: ${{ secrets.FACEBOOK_CLIENT_TOKEN }}
              run: echo "Got key"

            - name: Access Facebook properties file
              run: |
                 echo "facebook_client_token=$FACEBOOK_CLIENT_TOKEN" > ./facebook.properties

            - name: Upload Facebook properties
              uses: actions/upload-artifact@v2
              with:
                  name: facebook.properties
                  path: facebook.properties

            - name: Create google-services file
              run: cat /home/runner/work/hobby-matchmaker/hobby-matchmaker/app/google-services.json | base64

            - name: Fill google-services file
              env:
                  DATA: ${{ secrets.GOOGLE_SERVICES_JSON }}
              run: echo $DATA > /home/runner/work/hobby-matchmaker/hobby-matchmaker/app/google-services.json

            - name: Grant execute permission for gradlew
              run: chmod +x ./gradlew

            - name: Run Unit tests
              run: ./gradlew test
